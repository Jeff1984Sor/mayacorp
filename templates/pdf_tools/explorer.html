{% extends 'base.html' %}
{% load static %}

{% block title %}Concilia√ß√£o IA - MayaCorp{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto pb-20">

    <!-- 1. CABE√áALHO: T√≠tulo e Limpeza -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6 px-2 animate-in fade-in duration-700">
        <div class="flex items-center gap-5">
            <div class="w-16 h-16 bg-serene-blue/20 rounded-[24px] flex items-center justify-center text-serene-blue shadow-sm border border-white">
                <i class="fas fa-robot text-2xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-black text-slate-800 tracking-tight">Concilia√ß√£o Inteligente</h1>
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-[2px] mt-1">Processamento de arquivos assistido por IA</p>
            </div>
        </div>
        
        <button onclick="limparTudo()" class="btn btn-ghost bg-white shadow-sm border-slate-100 rounded-2xl hover:bg-rose-50 hover:text-rose-500 transition-all text-slate-400 normal-case font-bold px-6">
            <i class="fas fa-trash-alt mr-2 text-xs"></i> Limpar Ambiente
        </button>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- COLUNA 1: BOLETOS -->
        <div class="space-y-4">
            <div class="flex items-center justify-between px-4">
                <div class="flex items-center gap-3">
                    <div class="w-2 h-6 bg-serene-blue rounded-full shadow-[0_0_8px_rgba(165,216,255,0.8)]"></div>
                    <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-[3px]">1. Base de Boletos</h3>
                </div>
                <span id="count-boletos" class="badge bg-serene-blue/10 border-none text-serene-blue font-black rounded-lg px-3">{{ arquivos.boletos|length }}</span>
            </div>

            <div class="bg-white rounded-[40px] shadow-2xl shadow-slate-200/50 border border-white p-8 md:p-10">
                <div class="drop-zone group border-2 border-dashed border-slate-100 bg-slate-50/50 rounded-[32px] p-10 text-center cursor-pointer hover:bg-white hover:border-serene-blue/30 transition-all duration-500" 
                     id="drop-boletos" onclick="document.getElementById('input-boletos').click()">
                    <div class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center text-serene-blue mx-auto mb-4 shadow-xl shadow-slate-200 group-hover:scale-110 transition-transform">
                        <i class="fas fa-file-invoice-dollar text-2xl"></i>
                    </div>
                    <p class="text-sm font-bold text-slate-500 mb-1">Arraste os PDFs dos Boletos</p>
                    <p class="text-[10px] text-slate-300 font-medium uppercase tracking-widest">ou clique para selecionar</p>
                    <input type="file" id="input-boletos" multiple accept=".pdf" hidden onchange="handleUpload(this.files, 'boletos')">
                </div>
                
                <div class="file-list mt-8 space-y-2 custom-scroll overflow-y-auto" style="max-height: 250px;" id="list-boletos">
                    {% for f in arquivos.boletos %}
                    <div class="file-item bg-slate-50/50 p-4 rounded-2xl border border-slate-100 flex justify-between items-center group/item hover:bg-white hover:shadow-md transition-all" data-filename="{{ f }}">
                        <div class="flex items-center gap-3">
                            <span class="status-icon w-8 h-8 bg-white rounded-lg flex items-center justify-center text-xs shadow-sm">üìÑ</span>
                            <span class="filename text-xs font-bold text-slate-600 truncate max-w-[200px]">{{ f }}</span>
                        </div>
                        <button class="btn btn-ghost btn-circle btn-xs text-slate-200 hover:text-rose-500 opacity-0 group-hover/item:opacity-100 transition-opacity" onclick="deleteFile('boletos', '{{ f }}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- COLUNA 2: COMPROVANTES -->
        <div class="space-y-4">
            <div class="flex items-center justify-between px-4">
                <div class="flex items-center gap-3">
                    <div class="w-2 h-6 bg-soft-lavender rounded-full shadow-[0_0_8px_rgba(208,191,255,0.8)]"></div>
                    <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-[3px]">2. Lote de Comprovantes</h3>
                </div>
                <span id="count-comprovantes" class="badge bg-soft-lavender/20 border-none text-purple-600 font-black rounded-lg px-3">{{ arquivos.comprovantes|length }}</span>
            </div>

            <div class="bg-white rounded-[40px] shadow-2xl shadow-slate-200/50 border border-white p-8 md:p-10">
                <div class="drop-zone group border-2 border-dashed border-slate-100 bg-slate-50/50 rounded-[32px] p-10 text-center cursor-pointer hover:bg-white hover:border-soft-lavender/30 transition-all duration-500" 
                     id="drop-comprovantes" onclick="document.getElementById('input-comprovantes').click()">
                    <div class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center text-purple-400 mx-auto mb-4 shadow-xl shadow-slate-200 group-hover:scale-110 transition-transform">
                        <i class="fas fa-receipt text-2xl"></i>
                    </div>
                    <p class="text-sm font-bold text-slate-500 mb-1">Arquivo √önico de Comprovantes</p>
                    <p class="text-[10px] text-slate-300 font-medium uppercase tracking-widest">Sincroniza√ß√£o em massa</p>
                    <input type="file" id="input-comprovantes" accept=".pdf" hidden onchange="handleUpload(this.files, 'comprovantes')">
                </div>
                
                <div class="file-list mt-8 space-y-2 custom-scroll overflow-y-auto" style="max-height: 250px;" id="list-comprovantes">
                    {% for f in arquivos.comprovantes %}
                    <div class="file-item bg-slate-50/50 p-4 rounded-2xl border border-slate-100 flex justify-between items-center group/item hover:bg-white hover:shadow-md transition-all" data-filename="{{ f }}">
                        <div class="flex items-center gap-3">
                            <span class="status-icon w-8 h-8 bg-white rounded-lg flex items-center justify-center text-xs shadow-sm">üóÇÔ∏è</span>
                            <span class="filename text-xs font-bold text-slate-600 truncate max-w-[200px]">{{ f }}</span>
                        </div>
                        <button class="btn btn-ghost btn-circle btn-xs text-slate-200 hover:text-rose-500 opacity-0 group-hover/item:opacity-100 transition-opacity" onclick="deleteFile('comprovantes', '{{ f }}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- BOT√ÉO DE PROCESSAMENTO -->
    <div class="mt-12 text-center">
        <button id="btn-processar" class="btn h-20 bg-slate-800 border-none text-white rounded-[2rem] px-16 shadow-2xl shadow-slate-400 normal-case font-black text-xl italic hover:bg-black hover:scale-[1.02] transition-all disabled:bg-slate-100 disabled:text-slate-300 disabled:shadow-none" onclick="startProcessing()" disabled>
            <i class="fas fa-bolt mr-3"></i> INICIAR PROCESSAMENTO IA
        </button>
        <div class="text-[10px] text-slate-300 font-black uppercase tracking-[3px] mt-4" id="btn-help-text">Aguardando arquivos para an√°lise</div>
    </div>

    <!-- PAINEL DE EXECU√á√ÉO -->
    <div id="execution-panel" class="mt-16 animate-in slide-in-from-bottom-10 duration-700" style="display: none;">
        <div class="bg-white rounded-[45px] shadow-2xl shadow-slate-200/50 border border-white overflow-hidden">
            <div class="p-8 border-b border-slate-50 flex items-center justify-between bg-slate-50/30">
                <div class="flex items-center gap-3">
                    <div class="flex gap-1.5">
                        <div class="w-3 h-3 rounded-full bg-rose-300"></div>
                        <div class="w-3 h-3 rounded-full bg-amber-300"></div>
                        <div class="w-3 h-3 rounded-full bg-mint-green shadow-[0_0_8px_rgba(178,242,187,1)]"></div>
                    </div>
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-4">Monitor de Intelig√™ncia MayaCorp</span>
                </div>
            </div>

            <div class="p-10 md:p-14">
                <!-- Progresso Sleek -->
                <div class="mb-12">
                    <div class="flex justify-between items-end mb-4 px-2">
                        <label class="text-sm font-black text-slate-700 tracking-tight" id="progress-label">Iniciando motores...</label>
                        <span class="text-[10px] font-black text-serene-blue uppercase tracking-widest" id="progress-percent">0%</span>
                    </div>
                    <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden p-0.5 border border-slate-50 shadow-inner">
                        <div id="main-progress-bar" class="h-full bg-serene-blue rounded-full transition-all duration-500 shadow-[0_0_15px_rgba(165,216,255,0.8)]" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Terminal Log (Moderno) -->
                <div id="terminal-log" class="bg-slate-900 rounded-[32px] p-8 h-80 overflow-y-auto font-mono text-[11px] leading-relaxed shadow-2xl border border-slate-800">
                    <div class="text-emerald-500 opacity-50 italic mb-2 tracking-widest uppercase text-[9px]">_ Aguardando sinal do processador...</div>
                </div>

                <!-- √Årea de Download (Sucesso) -->
                <div id="download-area" class="text-center mt-12 p-10 bg-mint-green/5 rounded-[40px] border border-mint-green/10 animate-in zoom-in duration-500" style="display: none;">
                    <div class="w-20 h-20 bg-white rounded-[2.5rem] flex items-center justify-center text-emerald-500 mx-auto mb-6 shadow-xl shadow-mint-green/20">
                        <i class="fas fa-check-double text-3xl"></i>
                    </div>
                    <h4 class="text-2xl font-black text-slate-800 tracking-tight">Concilia√ß√£o Conclu√≠da!</h4>
                    <p class="text-slate-400 font-medium mt-2" id="stats-summary"></p>
                    
                    <a id="download-link" href="#" class="btn h-16 bg-mint-green border-none text-emerald-900 rounded-2xl px-12 mt-8 shadow-xl shadow-mint-green/30 normal-case font-black text-lg italic hover:bg-emerald-400 hover:scale-105 transition-all" download>
                        <i class="fas fa-download mr-2"></i> BAIXAR PACOTE CONCILIADO (.ZIP)
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container (Substituindo o padr√£o) -->
<div id="toast-container" class="fixed top-10 right-10 z-[9999] flex flex-col gap-3"></div>

<style>
    #terminal-log::-webkit-scrollbar { width: 6px; }
    #terminal-log::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #F1F5F9; border-radius: 10px; }
    
    .drag-over { border-color: #A5D8FF !important; background: white !important; transform: scale(1.02); }
    
    .pulse-btn { animation: soft-pulse 2s infinite; }
    @keyframes soft-pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(165, 216, 255, 0.7); }
        70% { transform: scale(1.02); box-shadow: 0 0 0 15px rgba(165, 216, 255, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(165, 216, 255, 0); }
    }
</style>

<script>
    // ============================================================
    // SEU ENGINE ORIGINAL (MANTIDO INTEGRALMENTE)
    // ============================================================
    const MAX_FILE_SIZE = 50 * 1024 * 1024;
    const MAX_BUFFER = 1024 * 1024;
    
    function safeId(filename) { return 'file-' + filename.replace(/[^a-zA-Z0-9]/g, '_'); }
    
    function showToast(message, type = 'info') {
        const bg = type === 'success' ? 'bg-mint-green text-emerald-900' : (type === 'error' ? 'bg-rose-500 text-white' : 'bg-slate-800 text-white');
        const toastHtml = `<div class="p-4 rounded-2xl shadow-2xl ${bg} font-bold text-xs animate-in slide-in-from-right-10">${message}</div>`;
        const container = document.getElementById('toast-container');
        container.insertAdjacentHTML('beforeend', toastHtml);
        const el = container.lastElementChild;
        setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 500); }, 3000);
    }
    
    function logToTerminal(msg, color='#10b981') {
        const term = document.getElementById('terminal-log');
        const div = document.createElement('div');
        div.className = 'mb-1';
        div.style.color = color;
        div.innerHTML = `<span class="opacity-30 mr-2 text-[10px] font-bold">${new Date().toLocaleTimeString()}</span> <span class="tracking-tight font-mono">${msg}</span>`;
        term.appendChild(div);
        term.scrollTop = term.scrollHeight;
    }

    function updateCounter(tipo, delta) {
        const badgeId = (tipo === 'boletos') ? 'count-boletos' : 'count-comprovantes';
        const badge = document.getElementById(badgeId);
        if(badge) {
            let current = parseInt(badge.innerText || "0");
            let novo = Math.max(0, current + delta);
            badge.innerText = novo;
        }
        verificarProntoParaProcessar();
    }

    function verificarProntoParaProcessar() {
        const boletos = document.querySelectorAll('#list-boletos .file-item').length;
        const comprovantes = document.querySelectorAll('#list-comprovantes .file-item').length;
        const btn = document.getElementById('btn-processar');
        const helpText = document.getElementById('btn-help-text');
        
        if (boletos > 0 && comprovantes === 1) {
            btn.disabled = false;
            btn.classList.add('pulse-btn');
            helpText.textContent = `Pronto para processar ${boletos} itens!`;
            helpText.classList.replace('text-slate-300', 'text-emerald-500');
        } else {
            btn.disabled = true;
            btn.classList.remove('pulse-btn');
            helpText.classList.replace('text-emerald-500', 'text-slate-300');
            if (comprovantes > 1) helpText.textContent = 'Aten√ß√£o: Envie apenas 1 arquivo de comprovantes';
            else helpText.textContent = 'Aguardando arquivos para an√°lise';
        }
    }

    async function handleUpload(files, tipo) {
        if (!files || files.length === 0) return;
        if (tipo === 'comprovantes') {
            const atual = document.querySelectorAll('#list-comprovantes .file-item').length;
            if (atual > 0) {
                if (!confirm('Substituir o arquivo de comprovantes existente?')) return;
                const items = document.querySelectorAll('#list-comprovantes .file-item');
                for (let item of items) await deleteFile('comprovantes', item.getAttribute('data-filename'), false);
            }
            if (files.length > 1) { showToast('Apenas o primeiro arquivo ser√° usado', 'warning'); files = [files[0]]; }
        }
        
        const container = document.getElementById(`list-${tipo}`);
        for (let file of files) {
            if (!file.name.toLowerCase().endsWith('.pdf')) { showToast(`‚ùå ${file.name}: Apenas PDFs`, 'error'); continue; }
            if (file.size > MAX_FILE_SIZE) { showToast(`‚ùå ${file.name}: Muito grande`, 'error'); continue; }
            
            const tempId = 'temp-' + Date.now();
            const div = document.createElement('div');
            div.className = 'file-item bg-slate-50 p-4 rounded-2xl border border-slate-100 flex justify-between items-center';
            div.id = tempId;
            div.innerHTML = `<div class="text-xs font-bold text-slate-400"><i class="fas fa-spinner fa-spin mr-2"></i> Subindo ${file.name}...</div>`;
            container.appendChild(div);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('tipo', tipo);

            try {
                const res = await fetch("{% url 'api_upload' %}", { method: 'POST', body: formData });
                const data = await res.json();
                if (data.status === 'ok') {
                    const finalDiv = document.getElementById(tempId);
                    finalDiv.setAttribute('data-filename', data.filename);
                    finalDiv.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="status-icon w-8 h-8 bg-white rounded-lg flex items-center justify-center text-xs shadow-sm">${tipo === 'boletos' ? 'üìÑ' : 'üóÇÔ∏è'}</span>
                            <span class="filename text-xs font-bold text-slate-600 truncate max-w-[200px]">${data.filename}</span>
                        </div>
                        <button class="btn btn-ghost btn-circle btn-xs text-slate-200 hover:text-rose-500" onclick="deleteFile('${tipo}', '${data.filename}')"><i class="fas fa-times"></i></button>
                    `;
                    updateCounter(tipo, 1);
                }
            } catch(e) { div.remove(); showToast('Erro no upload', 'error'); }
        }
    }

    async function deleteFile(tipo, filename, confirmar = true) {
        if (confirmar && !confirm(`Remover "${filename}"?`)) return;
        try {
            await fetch("{% url 'api_delete' %}", {
                method: 'POST',
                body: JSON.stringify({ tipo, filename }),
                headers: { 'Content-Type': 'application/json' }
            });
            document.querySelector(`.file-item[data-filename="${filename}"]`).remove();
            updateCounter(tipo, -1);
        } catch(e) { showToast('Erro ao remover', 'error'); }
    }

    async function limparTudo() {
        if (!confirm("Apagar todos os arquivos do ambiente?")) return;
        try {
            await fetch("{% url 'api_limpar' %}", { method: 'POST' });
            location.reload();
        } catch(e) { showToast("Erro ao limpar", 'error'); }
    }

    async function startProcessing() {
        const btn = document.getElementById('btn-processar');
        const panel = document.getElementById('execution-panel');
        const term = document.getElementById('terminal-log');
        const pBar = document.getElementById('main-progress-bar');
        
        panel.style.display = 'block';
        panel.scrollIntoView({ behavior: 'smooth' });
        btn.disabled = true;
        btn.innerHTML = '<span class="loading loading-spinner"></span> IA PROCESSANDO...';
        term.innerHTML = '';
        logToTerminal('üöÄ Conectando ao Processador MayaCorp...');
        
        try {
            const response = await fetch("{% url 'api_processar' %}");
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();
                for (let line of lines) {
                    if (!line.trim()) continue;
                    handleServerEvent(JSON.parse(line));
                }
            }
        } catch (error) { logToTerminal("‚ùå ERRO FATAL: " + error.message, '#ff4d4d'); btn.disabled = false; }
    }

    function handleServerEvent(ev) {
        const pBar = document.getElementById('main-progress-bar');
        const pLabel = document.getElementById('progress-label');
        const pPercent = document.getElementById('progress-percent');

        if (ev.type === 'log') logToTerminal(ev.data);
        else if (ev.type === 'comp_status') { pBar.style.width = '30%'; pLabel.innerText = `Lendo Comprovantes...`; pPercent.innerText = '30%'; }
        else if (ev.type === 'file_start') { 
            pLabel.innerText = `Analisando: ${ev.data.filename}`; 
            const row = document.querySelector(`.file-item[data-filename="${ev.data.filename}"]`);
            if(row) row.classList.add('bg-blue-50');
        }
        else if (ev.type === 'file_done') {
            const total = document.querySelectorAll('#list-boletos .file-item').length;
            const row = document.querySelector(`.file-item[data-filename="${ev.data.filename}"]`);
            if(row) {
                row.classList.replace('bg-blue-50', ev.data.status === 'success' ? 'bg-emerald-50' : 'bg-rose-50');
                row.querySelector('.status-icon').innerHTML = ev.data.status === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
            }
            // C√°lculo de progresso simplificado
            let currentIdx = parseInt(pPercent.innerText) || 30;
            let nextPercent = Math.min(95, currentIdx + (70/total));
            pBar.style.width = nextPercent + '%';
            pPercent.innerText = Math.round(nextPercent) + '%';
        }
        else if (ev.type === 'finish') {
            pBar.style.width = '100%';
            pPercent.innerText = '100%';
            pLabel.innerText = "Processamento Conclu√≠do!";
            document.getElementById('stats-summary').textContent = `${ev.data.matches} encontrados de ${ev.data.total} boletos.`;
            document.getElementById('download-link').href = ev.data.url;
            document.getElementById('download-area').style.display = 'block';
            btn.innerHTML = '<i class="fas fa-redo"></i> NOVO PROCESSAMENTO';
            btn.disabled = false;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        ['drop-boletos', 'drop-comprovantes'].forEach(id => {
            const zone = document.getElementById(id);
            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', (e) => { e.preventDefault(); zone.classList.remove('drag-over'); handleUpload(e.dataTransfer.files, id.split('-')[1]); });
        });
    });
</script>
{% endblock %}