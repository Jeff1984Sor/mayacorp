{% extends 'base.html' %}
{% load static %}

{% block title %}Editor de Modelo | MayaCorp Fit{% endblock %}

{% block content %}
<!-- Carrega o CKEditor (Foco em Compatibilidade PDF) -->
<script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>

<div class="max-w-7xl mx-auto pb-24 px-4">
    
    <!-- HEADER: Identidade Studio Premium -->
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 gap-8 px-2">
        <div class="flex items-center gap-6">
            <!-- Ícone em MARSALA -->
            <div class="w-16 h-16 bg-primary rounded-[22px] flex items-center justify-center text-white shadow-xl shadow-primary/30 border-2 border-white transition-transform hover:rotate-6">
                <i class="fas fa-file-pen text-2xl"></i>
            </div>
            <div>
                <h1 class="text-4xl font-black text-slate-900 tracking-tighter uppercase">Editor de Modelos</h1>
                <p class="text-[11px] text-primary font-black uppercase tracking-[3px] mt-1">
                    Criação de <span class="text-slate-900">Documentos Dinâmicos</span>
                </p>
            </div>
        </div>
        
        <a href="{% url 'template_list' %}" 
           class="btn bg-white border-2 border-slate-200 shadow-sm rounded-2xl hover:bg-slate-50 transition-all text-slate-600 font-black px-8 h-14">
            <i class="fas fa-arrow-left mr-2 text-xs"></i> VOLTAR À LISTA
        </a>
    </header>

    <form method="post">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            
            <!-- COLUNA DA ESQUERDA: EDITOR (MÁXIMA NITIDEZ) -->
            <div class="lg:col-span-9 space-y-10">
                
                <!-- Nome do Modelo (Destaque em MARSALA) -->
                <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl shadow-slate-200/60 border border-slate-100 relative overflow-hidden">
                    <div class="absolute left-0 top-0 w-1.5 h-full bg-primary"></div>
                    <div class="form-control w-full">
                        <label class="label mb-3">
                            <span class="label-text text-[11px] font-black text-slate-500 uppercase tracking-[2px] ml-2">Título Identificador do Contrato</span>
                        </label>
                        <input type="text" name="nome" value="{{ form.instance.nome|default:'' }}" placeholder="EX: CONTRATO DE PILATES - SEMESTRAL" required
                               class="input w-full bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-primary focus:ring-0 transition-all text-slate-900 font-black h-16 px-8 text-lg placeholder:text-slate-300">
                    </div>
                </div>

                <!-- Editor Principal (Soft UI Luxury) -->
                <div class="bg-white rounded-[3rem] shadow-2xl shadow-slate-200/60 border border-slate-100 overflow-hidden relative">
                    <div class="p-8 border-b border-slate-50 flex items-center justify-between bg-slate-50/50">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-align-left text-primary"></i>
                            <h3 class="text-xs font-black text-slate-900 uppercase tracking-[3px]">Estrutura do Documento</h3>
                        </div>
                        <div class="flex items-center gap-4 bg-white px-5 py-2.5 rounded-2xl border border-slate-200 shadow-sm">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Status do Modelo</span>
                            <input type="checkbox" name="ativo" class="toggle toggle-primary scale-110" id="id_ativo" {% if form.instance.ativo %}checked{% endif %}>
                        </div>
                    </div>
                    
                    <!-- Container do Editor -->
                    <div class="p-4 bg-white">
                        <textarea name="texto_html" id="editor1">{{ form.instance.texto_html }}</textarea>
                    </div>
                </div>

                <!-- Botão Salvar (AZUL VIBRANTE) -->
                <div class="flex flex-col md:flex-row justify-between items-center gap-8 bg-slate-900 p-8 rounded-[2.5rem] shadow-2xl">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center text-accent">
                            <i class="fas fa-shield-halved"></i>
                        </div>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-[2px] leading-relaxed italic">
                            O conteúdo será salvo em formato HTML <br><span class="text-white">compatível com renderização PDF MayaCorp</span>
                        </p>
                    </div>
                    <button type="submit" class="btn bg-secondary hover:bg-blue-800 border-none text-white rounded-2xl px-16 h-20 shadow-xl shadow-secondary/30 font-black text-xl uppercase tracking-widest transition-all hover:scale-105 active:scale-95 group">
                        <i class="fas fa-cloud-arrow-up mr-3 group-hover:animate-bounce"></i> SALVAR MODELO
                    </button>
                </div>
            </div>

            <!-- COLUNA DA DIREITA: VARIÁVEIS (AMARELO MÁGICO) -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-[2.5rem] shadow-2xl shadow-slate-200/60 border border-slate-100 sticky top-28 overflow-hidden">
                    <div class="p-8 bg-secondary flex items-center gap-4 text-white">
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                            <i class="fas fa-magic text-accent animate-pulse"></i>
                        </div>
                        <h3 class="text-[11px] font-black uppercase tracking-[3px]">Variáveis</h3>
                    </div>
                    
                    <div class="p-6 overflow-y-auto custom-scroll" style="max-height: calc(100vh - 450px);">
                        <div class="bg-accent/10 p-4 rounded-xl border border-accent/20 mb-6">
                            <p class="text-[10px] text-amber-900 font-black uppercase leading-relaxed text-center">
                                <i class="fas fa-mouse mr-1"></i> CLIQUE DUPLO PARA INSERIR
                            </p>
                        </div>
                        
                        <div class="space-y-2">
                            {% for var in variaveis %}
                                <button type="button" 
                                        class="w-full text-left p-4 rounded-2xl border-2 border-slate-50 hover:border-secondary hover:bg-secondary/5 group transition-all"
                                        ondblclick="inserirVariavel('{{ var.codigo }}')">
                                    <div class="flex flex-col">
                                        <span class="text-xs font-black text-slate-800 uppercase tracking-tight group-hover:text-secondary transition-colors">{{ var.desc }}</span>
                                        <code class="text-[10px] text-primary font-mono mt-2 bg-red-50 px-2 py-1 rounded-lg w-fit group-hover:bg-primary group-hover:text-white transition-all">{{ var.codigo }}</code>
                                    </div>
                                </button>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Dica de Logo -->
                    <div class="p-8 bg-slate-50 border-t border-slate-100">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-image text-primary text-lg mt-1"></i>
                            <p class="text-[10px] text-slate-500 font-bold leading-relaxed uppercase tracking-tight">
                                Use o ícone de imagem no editor para inserir a sua <span class="text-primary font-black">LOGOMARCA</span> no contrato.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- ESTILIZAÇÃO DO CKEDITOR STUDIO LUXO -->
<style>
    .cke_chrome { border: none !important; box-shadow: none !important; border-radius: 0 !important; }
    .cke_top { 
        background: #0f172a !important; /* Toolbar Escura para contraste */
        border-bottom: 2px solid #1e293b !important; 
        padding: 15px !important; 
    }
    .cke_bottom { background: #ffffff !important; border-top: 1px solid #f1f5f9 !important; padding: 10px !important; }
    
    /* Botões da Toolbar do CKEditor nítidos */
    .cke_button_icon { filter: brightness(0) invert(1); } /* Ícones brancos no fundo escuro */
    .cke_combo_button { background: #1e293b !important; border: 1px solid #334155 !important; border-radius: 8px !important; }
    .cke_combo_text { color: #fff !important; font-weight: bold !important; }
    
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { @apply bg-slate-200 rounded-full; }
</style>

<script>
    // Configuração do CKEditor focada em Nitidez e Documentação
    CKEDITOR.replace('editor1', {
        height: 600,
        removePlugins: 'elementspath',
        resize_enabled: false,
        uiColor: '#0f172a', // Interface Dark para a toolbar
        contentsCss: ['https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap'],
        bodyClass: 'document-editor',
        toolbar: [
            { name: 'document', items: ['Source', '-', 'Preview', 'Print'] },
            { name: 'clipboard', items: ['Cut', 'Copy', 'Paste', 'Undo', 'Redo'] },
            { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Strike', '-', 'RemoveFormat'] },
            { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock'] },
            { name: 'insert', items: ['Image', 'Table', 'HorizontalRule', 'SpecialChar'] },
            { name: 'styles', items: ['Format', 'FontSize'] },
            { name: 'colors', items: ['TextColor', 'BGColor'] }
        ],
        fontSize_sizes: '8/8pt;9/9pt;10/10pt;11/11pt;12/12pt;14/14pt;16/16pt;18/18pt;24/24pt;36/36pt',
    });

    function inserirVariavel(texto) {
        CKEDITOR.instances.editor1.insertText(texto);
        
        // Notificação Premium (AZUL VIBRANTE)
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-12 right-12 bg-secondary text-white px-10 py-5 rounded-[1.5rem] shadow-2xl text-xs font-black uppercase tracking-widest animate-in slide-in-from-bottom-10 z-[9999] border-4 border-white/20';
        toast.innerHTML = `<i class="fas fa-magic text-accent mr-3"></i> Variável Adicionada!`;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('animate-out', 'fade-out', 'slide-out-to-bottom-10');
            setTimeout(() => toast.remove(), 500);
        }, 2000);
    }
</script>
{% endblock %}