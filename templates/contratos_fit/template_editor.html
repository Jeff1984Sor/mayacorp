{% extends 'base.html' %}

{% block title %}Editor de Contrato{% endblock %}

{% block content %}
<!-- Carrega o CKEditor da nuvem -->
<script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>

<div class="container-fluid py-3">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold">Editor de Modelo de Contrato</h4>
        <a href="{% url 'template_list' %}" class="btn btn-outline-secondary">Voltar</a>
    </div>

    <form method="post">
        {% csrf_token %}
        
        <div class="row">
            <!-- COLUNA DA ESQUERDA: EDITOR -->
            <div class="col-md-9">
                <div class="mb-3">
                    <label class="form-label fw-bold">Nome do Modelo</label>
                    <input type="text" name="nome" class="form-control" value="{{ form.instance.nome|default:'' }}" required>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Conteúdo do Contrato</label>
                    <textarea name="texto_html" id="editor1">{{ form.instance.texto_html }}</textarea>
                </div>
                
                <div class="form-check mb-3">
                    <input type="checkbox" name="ativo" class="form-check-input" id="id_ativo" {% if form.instance.ativo %}checked{% endif %}>
                    <label class="form-check-label" for="id_ativo">Modelo Ativo</label>
                </div>

                <button type="submit" class="btn btn-success btn-lg px-5">Salvar Modelo</button>
            </div>

            <!-- COLUNA DA DIREITA: VARIÁVEIS -->
            <div class="col-md-3">
                <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                    <div class="card-header bg-primary text-white fw-bold">
                        <i class="fas fa-magic me-2"></i> Variáveis Dinâmicas
                    </div>
                    <div class="card-body bg-light p-2" style="max-height: 500px; overflow-y: auto;">
                        <p class="small text-muted mb-2">Clique duas vezes para inserir no texto:</p>
                        
                        <div class="list-group">
                            {% for var in variaveis %}
                                <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                                        ondblclick="inserirVariavel('{{ var.codigo }}')" title="Clique duplo para inserir">
                                    <span class="small fw-bold">{{ var.desc }}</span>
                                    <span class="badge bg-secondary rounded-pill" style="font-size: 0.6rem;">VAR</span>
                                </button>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="card-footer small text-muted">
                        Para colocar o Logo, clique no ícone de Imagem do editor e cole o link da sua logo.
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    // Inicia o CKEditor
    CKEDITOR.replace('editor1', {
        height: 500,
        removePlugins: 'elementspath', // Limpa a barra inferior
        resize_enabled: false
    });

    // Função Mágica para inserir onde o cursor está
    function inserirVariavel(texto) {
        CKEDITOR.instances.editor1.insertText(texto);
    }
</script>
{% endblock %}