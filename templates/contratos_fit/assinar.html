{% extends 'base.html' %}
{% load static %}

{% block title %}Assinatura Digital | MayaCorp Fit{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto pb-24 px-4">

    <!-- HEADER -->
    <header class="text-center mb-12">
        <div class="w-24 h-24 bg-primary rounded-[2.5rem] flex items-center justify-center text-white mx-auto mb-8 shadow-2xl shadow-primary/30 border-4 border-white">
            <i class="fas fa-file-signature text-3xl"></i>
        </div>
        <h1 class="text-4xl font-black text-slate-900 tracking-tighter uppercase">
            Assinatura Digital
        </h1>
        <div class="mt-4 flex flex-wrap justify-center gap-3">
            <span class="badge bg-secondary text-white font-black px-4 py-3 rounded-xl uppercase tracking-widest text-[10px]">
                PLANO: {{ contrato.plano.nome }}
            </span>
            <span class="badge bg-slate-900 text-white font-black px-4 py-3 rounded-xl uppercase tracking-widest text-[10px]">
                ALUNO: {{ contrato.aluno.nome }}
            </span>
        </div>
    </header>

    <!-- CARD -->
    <div class="bg-white rounded-[3rem] shadow-2xl border border-slate-100 overflow-hidden relative">

        <div class="p-10 md:p-16">

            <!-- ETAPA 1 -->
            <div class="flex items-center gap-4 mb-6">
                <div class="step">01</div>
                <h6 class="step-title">Leitura dos Termos</h6>
            </div>

            <div class="bg-slate-50 rounded-[2.5rem] p-10 h-96 overflow-y-auto custom-scroll border border-slate-100 mb-12">
                <div class="prose max-w-none">
                    {{ texto_contrato|safe }}
                </div>
            </div>

            <!-- ETAPA 2 -->
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4">
                    <div class="step bg-primary">02</div>
                    <h6 class="step-title">Assinatura</h6>
                </div>
                <button onclick="limpar()" class="btn btn-ghost btn-xs text-primary font-black uppercase">
                    <i class="fas fa-eraser mr-2"></i> Limpar
                </button>
            </div>

            <!-- CANVAS -->
            <div class="relative mb-12">
                <canvas id="signature-pad"
                        class="w-full h-56 bg-slate-50 rounded-[2.5rem] border-2 border-dashed border-slate-200 cursor-crosshair shadow-inner"></canvas>

                <div id="sig-help" class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 pointer-events-none">
                    <i class="fas fa-hand-pointer text-3xl mb-3 animate-bounce"></i>
                    <span class="text-[10px] font-black uppercase tracking-widest">
                        Assine com o dedo ou mouse
                    </span>
                </div>
            </div>

            <!-- CONFIRMAR -->
            <button id="btn-assinar"
                    class="btn bg-emerald-500 hover:bg-emerald-600 h-20 w-full rounded-[1.5rem] text-white font-black uppercase tracking-widest text-xl shadow-2xl">
                <i class="fas fa-check-double mr-3"></i> CONFIRMAR ASSINATURA
            </button>

            <p class="text-center text-[10px] text-slate-400 font-black uppercase tracking-widest mt-6">
                Autenticação criptografada • MayaCorp Secure Protocol v4
            </p>

        </div>
    </div>
</div>

<style>
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }

    .step {
        @apply w-10 h-10 rounded-2xl bg-secondary text-white flex items-center justify-center font-black shadow-lg;
    }

    .step-title {
        @apply text-[11px] font-black uppercase tracking-widest text-slate-900;
    }

    /* IMPORTANTE: NÃO BLOQUEIA O SITE TODO */
    #signature-pad {
        touch-action: none;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
    const canvas = document.getElementById('signature-pad');
    const help = document.getElementById('sig-help');
    const btn = document.getElementById('btn-assinar');

    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    const signaturePad = new SignaturePad(canvas, {
        penColor: '#0f172a'
    });

    signaturePad.addEventListener('beginStroke', () => help.style.opacity = '0');

    function limpar() {
        signaturePad.clear();
        help.style.opacity = '1';
    }

    function getCookie(name) {
        return document.cookie.split('; ')
            .find(row => row.startsWith(name + '='))
            ?.split('=')[1];
    }

    btn.addEventListener('click', () => {
        if (signaturePad.isEmpty()) {
            alert('Assinatura obrigatória.');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="loading loading-spinner"></span> PROCESSANDO...';

        fetch('', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'assinatura_data=' + encodeURIComponent(signaturePad.toDataURL())
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'ok') {
                location.href = "{% url 'aluno_detail' contrato.aluno.id %}";
            } else {
                alert('Erro ao salvar assinatura.');
                btn.disabled = false;
            }
        })
        .catch(() => {
            alert('Erro de conexão.');
            btn.disabled = false;
        });
    });
</script>
{% endblock %}
