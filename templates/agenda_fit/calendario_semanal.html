{% extends 'base.html' %}
{% load static %}

{% block title %}Agenda da Semana - MayaCorp{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-2">

    <!-- ================= BARRA DE FERRAMENTAS ================= -->
    <div class="bg-white/80 backdrop-blur-md rounded-[2rem] shadow-xl border border-slate-100 p-6 mb-10">
        <div class="flex flex-col lg:flex-row items-center justify-between gap-6">

            <!-- TÍTULO -->
            <div>
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-primary rounded-2xl flex items-center justify-center text-white shadow-lg">
                        <i class="fas fa-calendar-alt text-xl"></i>
                    </div>
                    <h1 class="text-2xl font-black text-slate-900 tracking-tighter">
                        Agenda da <span class="text-primary">Semana</span>
                    </h1>
                </div>
                <p class="text-slate-500 font-medium ml-16">
                    Visualize aulas, horários e alunos de forma simples.
                </p>
            </div>

            <!-- CONTROLES -->
            <div class="flex items-center gap-4 w-full lg:w-auto">

                <!-- NAVEGAÇÃO SEMANAL -->
                <div class="join bg-slate-100 p-1.5 rounded-2xl border">
                    <a href="?data={{ ant_semana }}&prof_id={{ prof_selecionado|default:'all' }}"
                       class="btn btn-ghost btn-sm join-item rounded-xl">
                        <i class="fas fa-chevron-left"></i>
                    </a>

                    <button type="button"
                            class="btn btn-ghost btn-sm join-item font-black px-6">
                        {{ inicio_semana|date:"d/M" }} — {{ fim_semana|date:"d/M" }}
                    </button>

                    <a href="?data={{ prox_semana }}&prof_id={{ prof_selecionado|default:'all' }}"
                       class="btn btn-ghost btn-sm join-item rounded-xl">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </div>

                <!-- FILTRO POR PROFISSIONAL (USER DJANGO) -->
                <form method="get" class="w-60">
                    <input type="hidden" name="data" value="{{ inicio_semana|date:'Y-m-d' }}">

                    <select name="prof_id"
                            class="select select-sm w-full bg-white border-2 rounded-xl font-bold"
                            onchange="this.form.submit()">

                        <option value="all"
                            {% if prof_selecionado == 'all' %}selected{% endif %}>
                            Todos os profissionais
                        </option>

                        {% for prof in lista_profissionais %}
                        <option value="{{ prof.user.id }}"
                            {% if prof_selecionado|stringformat:"s" == prof.user.id|stringformat:"s" %}selected{% endif %}>
                            {{ prof.user.get_full_name|default:prof.user.username }}
                        </option>
                        {% endfor %}

                    </select>
                </form>

            </div>
        </div>
    </div>

    <!-- ================= GRADE SEMANAL ================= -->
    <div class="flex gap-5 overflow-x-auto pb-10 custom-scroll px-2">
        {% for dia in dias_da_semana %}
        <div class="flex-1 min-w-[240px] flex flex-col gap-5">

            <!-- DIA -->
            <div class="p-5 rounded-[24px] text-center border-b-4
                {% if dia.hoje %}
                    bg-primary text-white shadow-2xl scale-105
                {% else %}
                    bg-white text-slate-400
                {% endif %}">
                <div class="text-[11px] font-black uppercase tracking-[3px] mb-1">
                    {{ dia.data|date:"l" }}
                </div>
                <div class="text-2xl font-black">
                    {{ dia.data|date:"d" }}
                    <span class="text-sm opacity-80">{{ dia.data|date:"M" }}</span>
                </div>
            </div>

            <!-- AULAS -->
            <div class="flex flex-col gap-4 min-h-[600px] bg-white/40 rounded-[2rem] p-3 border-2 border-dashed">

                {% for dia_index, lista_presencas in grade_semanal.items %}
                {% if dia_index == forloop.parentloop.counter0 %}
                {% for p in lista_presencas %}

                <div
                    onclick="openCheckinModal({
                        aluno: '{{ p.aluno.nome|escapejs }}',
                        data: '{{ p.aula.data_hora_inicio|date:"d/m/Y H:i" }}',
                        ocupacao: '{{ p.aula.presencas.count }}/{{ p.aula.unidade.capacidade_padrao }}',
                        cor: '{{ p.aula.profissional.cor }}',
                        action: '{% url 'gerenciar_aula' p.aula.id %}'
                    })"
                    class="group bg-white p-4 rounded-2xl shadow-md cursor-pointer hover:shadow-2xl hover:-translate-y-1 transition-all"
                    style="border-left: 10px solid {{ p.aula.profissional.cor }};"
                >

                    <div class="flex justify-between mb-3">
                        <span class="bg-slate-900 text-white text-[9px] font-black px-2 py-0.5 rounded">
                            {{ p.aula.data_hora_inicio|date:"H:i" }}
                        </span>
                        <span class="text-[9px] font-black uppercase text-emerald-500">
                            <i class="fas fa-users mr-1"></i>
                            {{ p.aula.presencas.count }}/{{ p.aula.unidade.capacidade_padrao }}
                        </span>
                    </div>

                    <div class="text-sm font-black text-slate-900 truncate">
                        {{ p.aluno.nome|upper }}
                    </div>

                    <div class="text-[10px] text-slate-400 font-bold mt-2 truncate">
                        <i class="fas fa-user-tie" style="color: {{ p.aula.profissional.cor }}"></i>
                        {{ p.aula.profissional.nome }}
                    </div>

                </div>

                {% endfor %}
                {% endif %}
                {% endfor %}

            </div>
        </div>
        {% endfor %}
    </div>

</div>

<!-- ================= MODAL CHECK-IN ================= -->
<dialog id="modal_checkin" class="modal">
    <div class="modal-box bg-white rounded-[2.5rem] p-10 max-w-lg shadow-2xl">

        <form id="checkinForm" method="post">
            {% csrf_token %}

            <div class="text-center mb-8">
                <div id="modalIcon"
                     class="w-24 h-24 rounded-[2.5rem] flex items-center justify-center mx-auto mb-5 shadow-inner">
                    <i class="fas fa-user-check text-4xl"></i>
                </div>

                <h3 id="modalAluno" class="text-3xl font-black text-slate-800"></h3>
                <p id="modalData" class="text-slate-400 text-sm font-black uppercase mt-2"></p>
                <p id="modalOcupacao" class="text-[10px] font-black text-primary uppercase mt-1"></p>
            </div>

            <div class="grid grid-cols-3 gap-3 mb-6">
                <label class="cursor-pointer">
                    <input type="radio" name="status" value="PRESENTE" class="peer hidden" required>
                    <div class="text-center py-4 rounded-2xl border peer-checked:bg-emerald-500 peer-checked:text-white uppercase text-[10px] font-black">
                        Presente
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" name="status" value="FALTA" class="peer hidden" required>
                    <div class="text-center py-4 rounded-2xl border peer-checked:bg-primary peer-checked:text-white uppercase text-[10px] font-black">
                        Falta
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" name="status" value="FALTA_JUSTIFICADA" class="peer hidden" required>
                    <div class="text-center py-4 rounded-2xl border peer-checked:bg-amber-500 peer-checked:text-white uppercase text-[10px] font-black">
                        Justificada
                    </div>
                </label>
            </div>

            <textarea name="evolucao_texto"
                      class="textarea w-full bg-slate-50 border rounded-2xl p-4"
                      rows="4"
                      placeholder="Anotações da aula..."></textarea>

            <div class="modal-action mt-8 flex gap-4">
                <button type="button"
                        onclick="modal_checkin.close()"
                        class="btn btn-ghost flex-1 rounded-2xl font-black uppercase text-xs">
                    Cancelar
                </button>
                <button type="submit"
                        class="btn bg-slate-900 text-white flex-1 rounded-2xl font-black uppercase tracking-widest h-14">
                    Salvar
                </button>
            </div>
        </form>
    </div>

    <form method="dialog" class="modal-backdrop bg-slate-900/60 backdrop-blur-md">
        <button>fechar</button>
    </form>
</dialog>

<script>
function openCheckinModal(data) {
    const modal = document.getElementById('modal_checkin')

    document.getElementById('modalAluno').innerText = data.aluno
    document.getElementById('modalData').innerText = data.data
    document.getElementById('modalOcupacao').innerText = `Ocupação: ${data.ocupacao}`

    const icon = document.getElementById('modalIcon')
    icon.style.backgroundColor = data.cor + '20'
    icon.style.color = data.cor

    const form = document.getElementById('checkinForm')
    form.action = data.action
    form.reset()

    modal.showModal()
}
</script>

{% endblock %}
