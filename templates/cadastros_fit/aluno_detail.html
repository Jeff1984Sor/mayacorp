{% extends 'base.html' %}
{% load static %}

{% block title %}Gestão de Cliente - {{ aluno.nome }}{% endblock %}

{% block content %}

<!-- CSS ESPECÍFICO DESTA TELA -->
<style>
    /* Estilos Visuais da Imagem */
    .text-purple { color: #6f42c1; }
    .bg-light-purple { background-color: #E0CFFC; }
    
    /* Avatar */
    .client-avatar {
        width: 80px; height: 80px;
        background-color: #ddd;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 40px; color: white;
        position: relative;
    }
    .client-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }

    /* Navegação de Abas (Apps) */
    .app-nav-container {
        background: #f8f9fa; border-radius: 8px; padding: 10px; margin-bottom: 30px;
        display: flex; flex-wrap: wrap; gap: 10px;
    }
    .app-nav-item {
        display: flex; align-items: center; gap: 8px;
        padding: 8px 15px; border-radius: 6px;
        text-decoration: none; color: #555; font-weight: 500;
        transition: 0.2s;
    }
    .app-nav-item:hover { background: #e2e6ea; }
    .app-nav-item.active { background: #ffe0cc; color: #e65100; } /* Laranja */

    /* Cards de Seleção */
    .option-card {
        background: white; border: 1px solid #dee2e6; border-radius: 10px;
        padding: 20px; height: 100%; cursor: pointer; transition: 0.3s;
        display: flex; flex-direction: column; 
    }
    .option-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .card-recorrente { background-color: #EADCF8; border-color: #D6BCF0; } /* Roxo */
    
    .icon-circle {
        width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        color: white; font-size: 1.2rem; margin-bottom: 15px;
    }
    /* Utilitários de cor para icones */
    .bg-i-purple { background-color: #563d7c; }
    .bg-i-green { background-color: #28a745; }
    .bg-i-orange { background-color: #fd7e14; }
    .bg-i-cyan { background-color: #17a2b8; }
</style>

<div class="container-fluid p-0">

    <!-- 1. TOPO: Título e Botões -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <small class="text-muted">Você está em: <strong>Gestão de Cliente (Cadastro Fit)</strong></small>
        <div class="d-flex gap-2">
            <button class="btn btn-primary btn-sm"><i class="fas fa-star"></i> Tutoriais</button>
            <button class="btn btn-outline-danger btn-sm"><i class="fas fa-exclamation-circle"></i> SOS</button>
        </div>
    </div>

    <!-- 2. CABEÇALHO DO ALUNO/CLIENTE -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <!-- Foto e Nome -->
                <div class="col-md-5 d-flex align-items-center gap-3">
                    <div class="client-avatar">
                        {% if aluno.foto %}
                            <img src="{{ aluno.foto.url }}" alt="Foto">
                        {% else %}
                            <i class="fas fa-user"></i>
                        {% endif %}
                    </div>
                    <div>
                        <!-- NOME VINDO DO BANCO -->
                        <h4 class="mb-0 fw-bold">{{ aluno.nome }}</h4> 
                        <small class="text-muted d-block">ID/Matrícula: {{ aluno.id }}</small>
                        <small class="text-muted">Unidade: {{ aluno.unidade|default:"Principal" }}</small>
                    </div>
                </div>

                <!-- Selects Rápidos -->
                <div class="col-md-4">
                    <div class="mb-2">
                        <select class="form-select form-select-sm border-0 border-bottom rounded-0">
                            <option selected>Nível: Padrão</option>
                            <option value="vip">VIP</option>
                        </select>
                    </div>
                </div>

                <!-- Ações Direita -->
                <div class="col-md-3 text-end">
                    <div class="mb-2"><a href="#" class="text-dark text-decoration-none small"><i class="fas fa-print"></i> Imprimir Ficha</a></div>
                    <div>
                        <a href="https://wa.me/55{{ aluno.telefone|cut:' '|cut:'-'|cut:'('|cut:')' }}" target="_blank" class="text-dark text-decoration-none small">
                            <i class="fab fa-whatsapp text-success"></i> Dar boas vindas
                        </a>
                    </div>
                </div>
            </div>

            <hr class="my-3 text-muted opacity-25">

            <!-- Links de Ação Rápida -->
            <div class="d-flex flex-wrap gap-3 align-items-center small text-muted">
                <!-- Botão Novo Contrato (Atalho) -->
                <a href="{% url 'novo_contrato' aluno.pk %}" class="text-primary fw-bold text-decoration-none">
                    <i class="fas fa-file-signature"></i> Novo Contrato
                </a>
                <span class="border-start mx-1"></span>

                <a href="{% url 'aluno_update' aluno.pk %}" class="text-dark text-decoration-none"><i class="fas fa-pen"></i> Ver/Editar cadastro</a>
                <span class="border-start mx-1"></span>
                <button type="button" class="btn btn-link p-0 text-muted text-decoration-none" data-bs-toggle="modal" data-bs-target="#modalDocumento">
                    <i class="fas fa-file-upload"></i> Docs Extras
                </button>
                <span class="border-start mx-1"></span>
                <a href="{% url 'aluno_delete' aluno.pk %}" class="text-danger text-decoration-none"><i class="fas fa-trash"></i> Excluir</a>
            </div>
        </div>
    </div>

    <!-- 2.5. INTEGRAÇÃO AGENDA FIT -->
    <div class="row mb-4 g-3">
        <!-- Card Próxima Aula -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100" style="background-color: #f0f7ff; border-left: 4px solid #0d6efd !important;">
                <div class="card-body">
                    <h6 class="text-primary fw-bold mb-2"><i class="fas fa-calendar-alt me-2"></i> Próxima Aula</h6>
                    {% if proxima_aula %}
                        <h5 class="fw-bold mb-1">{{ proxima_aula.data_hora_inicio|date:"d/m - H:i" }}</h5>
                        <p class="text-muted small mb-0">
                            Prof. {{ proxima_aula.profissional.nome_social|default:proxima_aula.profissional.nome }}<br>
                            Status: <span class="badge bg-success">{{ proxima_aula.get_status_display }}</span>
                        </p>
                    {% else %}
                        <p class="text-muted small mb-0">Nenhuma aula futura agendada.</p>
                        <a href="{% url 'calendario_semanal' %}" class="btn btn-sm btn-link px-0 text-decoration-none">Ver grade completa</a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Card Última Evolução -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100" style="background-color: #fff4e5; border-left: 4px solid #ff9800 !important;">
                <div class="card-body">
                    <h6 class="text-warning fw-bold mb-2" style="color: #e65100 !important;">
                        <i class="fas fa-file-medical me-2"></i> Última Evolução
                    </h6>
                    {% if ultima_evolucao %}
                        <small class="text-muted d-block fw-bold">{{ ultima_evolucao.data_hora_inicio|date:"d/m/Y" }}</small>
                        <p class="small mb-0 text-dark fst-italic">
                            "{{ ultima_evolucao.evolucao_texto|truncatechars:80 }}"
                        </p>
                    {% else %}
                        <p class="text-muted small mb-0">Nenhuma evolução registrada ainda.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 3. MENU DE NAVEGAÇÃO -->
    <div class="app-nav-container shadow-sm">
        <a href="#" class="app-nav-item active">
            <i class="fas fa-user-circle fs-5"></i> 
            <div class="lh-1">Central<br><small>Cadastro</small></div>
        </a>
        
        <!-- LINK CORRIGIDO: Financeiro (Filtra por este aluno na URL se você implementar filtro na view, senão vai pra lista geral) -->
        <a href="{% url 'financeiro_lista' %}?aluno={{ aluno.nome }}" class="app-nav-item">
            <i class="fas fa-dollar-sign fs-5"></i> Financeiro
        </a>
        
        <!-- LINK CORRIGIDO: Agenda -->
        <a href="{% url 'calendario_semanal' %}" class="app-nav-item">
            <i class="fas fa-calendar-alt fs-5"></i> Agenda
        </a>
        
        <a href="#" class="app-nav-item">
            <i class="fas fa-file-medical fs-5"></i> Prontuário
        </a>
    </div>

    <!-- 4. DASHBOARD - CARDS DE OPÇÕES -->
    <div class="text-center mb-4">
        <h3 class="fw-bold text-dark">Escolha uma das opções abaixo:</h3>
    </div>

    <div class="row g-4">
        <!-- Card 1: Serviços Recorrentes -->
        <div class="col-md-3">
            <div class="option-card card-recorrente text-start">
                <div class="mb-auto">
                    <div class="d-flex justify-content-between">
                        <div class="icon-circle bg-i-purple"><i class="fas fa-sync-alt"></i></div>
                        <i class="fas fa-file-invoice-dollar text-danger fs-4"></i>
                    </div>
                    <h5 class="fw-bold">Serviços<br>recorrentes</h5>
                    
                    <!-- LISTA DE CONTRATOS ATIVOS -->
                    {% if aluno.contratos.all %}
                        <div class="mt-2">
                            {% for c in aluno.contratos.all %}
                                <div class="bg-white bg-opacity-50 p-1 rounded mb-1 d-flex justify-content-between align-items-center small">
                                    <span class="text-truncate fw-bold">{{ c.plano.nome }}</span>
                                    <a href="{% url 'imprimir_contrato' c.id %}" target="_blank" class="text-dark" title="Imprimir">
                                        <i class="fas fa-print"></i>
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted small mb-3">Recomendados para clientes mensais.</p>
                        <div class="fw-bold small">Ativos: 0</div>
                    {% endif %}
                </div>
                
                <!-- BOTÃO DE VENDA -->
                <div class="mt-3 pt-3 border-top border-secondary border-opacity-25">
                    <a href="{% url 'novo_contrato' aluno.pk %}" class="btn btn-sm w-100" style="background-color: #6f42c1; color: white;">
                        <i class="fas fa-plus"></i> Vender Plano
                    </a>
                </div>
            </div>
        </div>

        <!-- Card 2: Pacotes Fixos -->
        <div class="col-md-3">
            <div class="option-card text-start">
                <div class="icon-circle bg-i-green"><i class="fas fa-star"></i></div>
                <h5 class="fw-bold">Pacotes<br>Fixos</h5>
                <p class="text-muted small mb-3">Planos longos ou parcelados.</p>
                <div class="fw-bold small">Ativos: {{ qtd_pacotes_fixos|default:"0" }}</div>
            </div>
        </div>

        <!-- Card 3: Pacotes Personalizados -->
        <div class="col-md-3">
            <div class="option-card text-start">
                <div class="icon-circle bg-i-orange"><i class="fas fa-user"></i></div>
                <h5 class="fw-bold">Pacotes<br>personalizados</h5>
                <p class="text-muted small mb-3">Sessões de fisioterapia/estética.</p>
                <div class="fw-bold small">Ativos: {{ qtd_pacotes_personal|default:"0" }}</div>
            </div>
        </div>

        <!-- Card 4: Avulso -->
        <div class="col-md-3">
            <div class="option-card text-start">
                <div class="icon-circle bg-i-cyan"><i class="fas fa-check-double"></i></div>
                <h5 class="fw-bold">Atendimento<br>avulso</h5>
                <p class="text-muted small mb-3">Atendimentos unitários ou experimentais.</p>
            </div>
        </div>
    </div>

</div>

<!-- Modal de Upload de Docs Extras -->
<div class="modal fade" id="modalDocumento" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Adicionar Documento Extra</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form action="{% url 'upload_documento_extra' aluno.pk %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="mb-3">
                <label class="form-label">Arquivo</label>
                <input type="file" name="arquivo" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Descrição</label>
                <input type="text" name="descricao" class="form-control" placeholder="Ex: Laudo Médico">
            </div>
            <button type="submit" class="btn btn-primary w-100">Enviar</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}