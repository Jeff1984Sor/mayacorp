{% extends 'base.html' %}
{% load static %}

{% block title %}{{ aluno.nome }} | MayaCorp Fit{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto pb-24 px-4 sm:px-6">

<!-- ================= HEADER DO ALUNO ================= -->
<header class="bg-white rounded-[3rem] shadow-2xl border border-slate-100 p-10 mb-10 relative overflow-hidden">
    <div class="absolute top-0 right-0 w-96 h-96 bg-primary/5 rounded-full -mr-40 -mt-40 blur-3xl"></div>

    <div class="relative z-10 flex flex-col lg:flex-row gap-10 items-center">
        <!-- FOTO -->
        <div class="relative">
            <div class="w-40 h-40 rounded-[3rem] overflow-hidden shadow-xl border-4 border-white bg-slate-100 flex items-center justify-center text-5xl font-black text-primary">
                {% if aluno.foto_rosto %}
                    <img src="{{ aluno.foto_rosto.url }}" class="w-full h-full object-cover">
                {% else %}
                    {{ aluno.nome|first }}
                {% endif %}
            </div>
        </div>

        <!-- INFO -->
        <div class="flex-1 text-center lg:text-left">
            <h1 class="text-4xl font-black text-slate-900 uppercase tracking-tight">
                {{ aluno.nome }}
            </h1>
            <p class="text-xs font-black text-slate-400 uppercase tracking-widest mt-1">
                ID #{{ aluno.id }}
            </p>

            <div class="flex flex-wrap justify-center lg:justify-start gap-6 mt-6">
                <div class="flex items-center gap-2 font-bold text-slate-600">
                    <i class="fab fa-whatsapp text-emerald-500"></i>
                    {{ aluno.telefone|default:"—" }}
                </div>
                <div class="flex items-center gap-2 font-bold text-slate-600">
                    <i class="far fa-id-card text-blue-500"></i>
                    {{ aluno.cpf|default:"CPF não informado" }}
                </div>
            </div>

            <!-- AÇÕES -->
            <div class="flex flex-wrap gap-3 mt-8 justify-center lg:justify-start">
                <a href="{% url 'aluno_update' aluno.pk %}"
                   class="btn bg-slate-900 text-white rounded-xl px-6 font-black uppercase text-[10px] tracking-widest">
                    Editar
                </a>

                <button onclick="enviarCobranca({{ aluno.id }})"
                        class="btn bg-emerald-500 text-white rounded-xl px-6 font-black uppercase text-[10px] tracking-widest">
                    Cobrar
                </button>

                <a href="{% url 'novo_contrato' aluno.pk %}"
                   class="btn bg-secondary text-white rounded-xl px-6 font-black uppercase text-[10px] tracking-widest">
                    Nova venda
                </a>
            </div>
        </div>
    </div>
</header>

<!-- ================= KPIs ================= -->
<section class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-10">
    <div class="card-kpi">
        Status
        <span class="ok">Ativo</span>
    </div>

    <div class="card-kpi">
        Financeiro
        {% if total_em_aberto > 0 %}
            <span class="bad">Em aberto</span>
        {% else %}
            <span class="ok">Em dia</span>
        {% endif %}
    </div>

    <div class="card-kpi">
        Última aula
        <span>{{ ultima_aula|default:"—" }}</span>
    </div>

    <div class="card-kpi">
        Frequência
        <span>{{ percentual_presenca }}%</span>
    </div>

    <div class="card-kpi">
        Próx. venc.
        <span>{{ proximo_vencimento|date:"d/m"|default:"—" }}</span>
    </div>
</section>

{% if faltas_consecutivas >= 3 %}
<div class="mb-8 bg-amber-50 border border-amber-200 rounded-2xl p-5 flex items-center gap-4">
    <i class="fas fa-exclamation-triangle text-amber-500"></i>
    <p class="text-xs font-black uppercase tracking-widest text-amber-800">
        Aluno com faltas recorrentes
    </p>
</div>
{% endif %}

<!-- ================= ABAS ================= -->
<div class="bg-white rounded-[3rem] shadow-2xl border border-slate-100 overflow-hidden">

<!-- NAV -->
<div class="flex bg-slate-50 p-2">
    <button class="tab-btn active" onclick="openTab(event,'financeiro')">Financeiro</button>
    <button class="tab-btn" onclick="openTab(event,'prontuario')">Prontuário</button>
    <button class="tab-btn" onclick="openTab(event,'agenda')">Agenda</button>
    <button class="tab-btn" onclick="openTab(event,'contratos')">Contratos</button>
</div>

<div class="p-10">

<!-- FINANCEIRO -->
<div id="financeiro" class="tab-content">
    <table class="table w-full">
        <thead>
            <tr>
                <th>Vencimento</th>
                <th>Descrição</th>
                <th>Valor</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for l in financeiro_completo %}
            <tr>
                <td>{{ l.data_vencimento|date:"d/m/Y" }}</td>
                <td>{{ l.descricao }}</td>
                <td>R$ {{ l.valor }}</td>
                <td>
                    {% if l.status == 'PAGO' %}
                        <span class="ok">Pago</span>
                    {% else %}
                        <span class="bad">Pendente</span>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="4">Nenhum lançamento financeiro</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- PRONTUÁRIO -->
<div id="prontuario" class="tab-content hidden space-y-4">
    {% for p in agenda_completa %}
    <div class="border rounded-2xl p-6 shadow-sm bg-white">
        <b>{{ p.aula.data_hora_inicio|date:"d/m/Y H:i" }}</b>
        — {{ p.aula.profissional.nome }}<br>
        <i class="text-sm text-slate-500">
            {{ p.aula.evolucao_texto|default:"Sem registro" }}
        </i>
    </div>
    {% empty %}
    <p class="text-slate-400 italic">Nenhum registro clínico.</p>
    {% endfor %}
</div>

<!-- AGENDA -->
<div id="agenda" class="tab-content hidden">
    <a href="{% url 'aluno_aulas_list' aluno.id %}"
       class="btn bg-secondary text-white rounded-xl">
        Ver agenda completa
    </a>
</div>

<!-- CONTRATOS -->
<div id="contratos" class="tab-content hidden grid md:grid-cols-2 gap-6">
    {% for c in contratos_completo %}
    <div class="border rounded-3xl p-8 shadow-sm bg-white">
        <b>{{ c.plano.nome }}</b><br>
        {{ c.data_inicio|date:"d/m/Y" }} — {{ c.data_fim|date:"d/m/Y" }}<br>
        <span class="font-black">R$ {{ c.valor_total }}</span>
    </div>
    {% empty %}
    <p class="text-slate-400 italic">Nenhum contrato ativo.</p>
    {% endfor %}
</div>

</div>
</div>
</div>

<!-- ================= ESTILOS ================= -->
<style>
.card-kpi{
    background:#fff;
    border:1px solid #eee;
    padding:16px;
    border-radius:16px;
    font-weight:900;
    text-transform:uppercase;
    font-size:10px;
}
.card-kpi span{
    display:block;
    font-size:18px;
}
.ok{color:#10b981}
.bad{color:#dc2626}

.tab-btn{
    flex:1;
    padding:16px;
    font-weight:900;
    text-transform:uppercase;
    font-size:11px;
    border-radius:12px;
}
.tab-btn.active{
    background:white;
    color:var(--color-primary);
}
.tab-content{
    animation:fade .25s ease;
}
@keyframes fade{
    from{opacity:0}
    to{opacity:1}
}
</style>

<!-- ================= SCRIPTS ================= -->
<script>
function openTab(e,id){
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.remove('hidden');
    e.currentTarget.classList.add('active');
}

function enviarCobranca(id){
    if(confirm('Enviar cobrança automática para este aluno?')){
        fetch(`/comunicacao/enviar-cobranca/${id}/`)
            .then(()=>alert('Cobrança enviada com sucesso'));
    }
}
</script>

{% endblock %}
